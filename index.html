<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0f0f1a" />
  <title>ğŸµ ìŒì•… ì»¤ë¦¬í˜ëŸ¼ ë§¤ë‹ˆì €</title>
  <meta name="description" content="ì˜¤ì¹´ë¦¬ë‚˜, ìš°ì¿¨ë ë ˆ, ì¹¼ë¦¼ë°” ë“± ë‹¤ì•…ê¸° ì»¤ë¦¬í˜ëŸ¼ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ ì•±" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon-192.svg" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <div class="app" id="app">
    <header class="header">
      <div>
        <h1 class="header__title">ğŸµ ìŒì•… ì»¤ë¦¬í˜ëŸ¼</h1>
        <p class="header__subtitle" id="header-subtitle">ë‹¤ì•…ê¸° ì»¤ë¦¬í˜ëŸ¼ ê´€ë¦¬</p>
      </div>
      <div class="header__actions">
        <button class="header__btn" id="btn-reset" title="ë°ì´í„° ì´ˆê¸°í™”">ğŸ”„</button>
      </div>
    </header>
    <nav class="tabs" id="main-tabs"></nav>
    <main class="content" id="main-content">
      <section class="view active" id="view-calendar">
        <div class="stats" id="stats"></div>
        <div class="calendar" id="calendar"></div>
        <div class="day-events" id="day-events"></div>
      </section>
    </main>
    <button class="fab" id="fab" title="ìˆ˜ì—… ì¶”ê°€">ï¼‹</button>
  </div>

  <!-- Lesson Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal__handle"></div>
      <h2 class="modal__title" id="modal-title">ìˆ˜ì—… ì¶”ê°€</h2>
      <form id="lesson-form">
        <input type="hidden" id="form-id" />
        <div class="form-row">
          <div class="form-group">
            <label for="form-instrument">ì•…ê¸°</label>
            <select id="form-instrument"></select>
          </div>
          <div class="form-group">
            <label for="form-week">ì£¼ì°¨</label>
            <input type="number" id="form-week" min="1" max="99" placeholder="1" />
          </div>
        </div>
        <div class="form-group">
          <label for="form-title">ìˆ˜ì—… ì£¼ì œ</label>
          <input type="text" id="form-title" placeholder="ì˜ˆ: ì˜¤ì¹´ë¦¬ë‚˜ì™€ ì¹œí•´ì§€ê¸°" />
        </div>
        <div class="form-group">
          <label for="form-desc">ì„¸ë¶€ ë‚´ìš©</label>
          <textarea id="form-desc" rows="3" placeholder="ìˆ˜ì—… ì„¸ë¶€ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="form-song">í•™ìŠµ ê³¡(ì„ íƒ)</label>
            <input type="text" id="form-song" placeholder="ì˜ˆ: ë¹„í–‰ê¸°" />
          </div>
          <div class="form-group">
            <label for="form-date">ìˆ˜ì—… ë‚ ì§œ(ì„ íƒ)</label>
            <input type="date" id="form-date" />
          </div>
        </div>
        <div class="form-group">
          <label for="form-status">ì§„í–‰ ìƒíƒœ</label>
          <select id="form-status">
            <option value="upcoming">ì˜ˆì •</option>
            <option value="done">ì™„ë£Œ</option>
          </select>
        </div>
        <div class="modal__btns">
          <button type="button" class="btn btn--cancel" id="btn-cancel">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn--save">ì €ì¥</button>
        </div>
        <div class="modal__btns" id="delete-row" style="display:none;">
          <button type="button" class="btn btn--delete" id="btn-delete">ğŸ—‘ï¸ ì´ ìˆ˜ì—… ì‚­ì œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Registration Modal -->
  <div class="modal-overlay" id="register-overlay">
    <div class="modal register-modal">
      <div class="modal__handle"></div>
      <div id="register-content"></div>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-dialog">
      <div class="confirm-dialog__title" id="confirm-title">í™•ì¸</div>
      <div class="confirm-dialog__msg" id="confirm-msg">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
      <div class="confirm-dialog__btns">
        <button class="btn btn--cancel" id="confirm-no">ì•„ë‹ˆì˜¤</button>
        <button class="btn btn--delete" id="confirm-yes">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="templates.js"></script>
  <script>
    (() => {
      'use strict';

      // â•â•â• STORAGE â•â•â•
      const STORAGE_KEY = 'music_curriculum_v2';
      const OLD_KEY = 'music_curriculum_data';

      function loadData() {
        let raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
        raw = localStorage.getItem(OLD_KEY);
        if (raw) {
          const old = JSON.parse(raw);
          const d = {
            instruments: [
              { id: 'ocarina', name: 'ì˜¤ì¹´ë¦¬ë‚˜', emoji: 'ğŸµ', color: '#ff7b6b', color2: '#ff9e5e' },
              { id: 'ukulele', name: 'ìš°ì¿¨ë ë ˆ', emoji: 'ğŸ¸', color: '#4ecdc4', color2: '#45b7d1' },
            ],
            lessons: old.lessons, nextId: old.nextId
          };
          saveData(d);
          return d;
        }
        return initDefaultData();
      }

      function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

      function calcDates(startDate, totalLessons, freq) {
        const dates = [];
        const start = startDate ? new Date(startDate) : new Date();
        if (!startDate) {
          const dow = start.getDay();
          start.setDate(start.getDate() + (dow === 0 ? 1 : dow === 1 ? 0 : 8 - dow));
        }
        let cur = new Date(start);
        for (let i = 0; i < totalLessons; i++) {
          dates.push(new Date(cur));
          if (freq === 1) { cur.setDate(cur.getDate() + 7); }
          else if (freq === 2) { cur.setDate(cur.getDate() + (i % 2 === 0 ? 3 : 4)); }
          else { const gaps = [2, 2, 3]; cur.setDate(cur.getDate() + gaps[i % 3]); }
        }
        return dates;
      }

      function generateLessons(templateKey, instrumentId, weekCount, startId, startDate, freq) {
        const t = TEMPLATES[templateKey];
        if (!t) return { lessons: [], nextId: startId };
        const f = freq || 1;
        const weeks = t.weeks.slice(0, weekCount);
        const dates = calcDates(startDate, weeks.length, f);
        let id = startId;
        const lessons = weeks.map((w, i) => ({
          id: id++, instrument: instrumentId, week: w.week,
          title: w.title, desc: w.desc, song: w.song,
          date: formatDate(dates[i]), status: 'upcoming'
        }));
        return { lessons, nextId: id };
      }

      function generateEmptyLessons(instrumentId, weekCount, startId, startDate, freq) {
        const f = freq || 1;
        const dates = calcDates(startDate, weekCount, f);
        let id = startId;
        const lessons = [];
        for (let i = 0; i < weekCount; i++) {
          lessons.push({
            id: id++, instrument: instrumentId, week: i + 1,
            title: `${i + 1}ì£¼ì°¨ ìˆ˜ì—…`, desc: 'ìˆ˜ì—… ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”',
            song: '', date: formatDate(dates[i]), status: 'upcoming'
          });
        }
        return { lessons, nextId: id };
      }

      function initDefaultData() {
        const d = { instruments: [], lessons: [], nextId: 1 };
        saveData(d);
        return d;
      }

      // â•â•â• HELPERS â•â•â•
      function formatDate(d) {
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      }
      function toDateObj(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); }
      function koreanDate(s) {
        if (!s) return '';
        const d = toDateObj(s), days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${days[d.getDay()]})`;
      }
      function getInst(id) { return data.instruments.find(i => i.id === id); }

      // â•â•â• STATE â•â•â•
      let data = loadData();
      let currentTab = 'calendar';
      let calYear, calMonth, selectedDate = null, editingId = null;
      const todayObj = new Date();
      calYear = todayObj.getFullYear();
      calMonth = todayObj.getMonth();

      // â•â•â• DOM â•â•â•
      const $ = id => document.getElementById(id);
      const $tabs = $('main-tabs');
      const $content = $('main-content');
      const $calendar = $('calendar');
      const $dayEvents = $('day-events');
      const $stats = $('stats');
      const $fab = $('fab');
      const $modalOvl = $('modal-overlay');
      const $modalTitle = $('modal-title');
      const $form = $('lesson-form');
      const $deleteRow = $('delete-row');
      const $confirmOvl = $('confirm-overlay');
      const $toast = $('toast');
      const $regOvl = $('register-overlay');
      const $regContent = $('register-content');
      const $fId = $('form-id'), $fInst = $('form-instrument'), $fWeek = $('form-week');
      const $fTitle = $('form-title'), $fDesc = $('form-desc'), $fSong = $('form-song');
      const $fDate = $('form-date'), $fStatus = $('form-status');

      // â•â•â• DYNAMIC TABS â•â•â•
      function renderTabs() {
        let html = `<button class="tab ${currentTab === 'calendar' ? 'active' : ''}" data-tab="calendar">ğŸ“… ìº˜ë¦°ë”</button>`;
        data.instruments.forEach(inst => {
          html += `<button class="tab ${currentTab === inst.id ? 'active' : ''}" data-tab="${inst.id}" style="--tc:${inst.color}">${inst.emoji} ${inst.name}</button>`;
        });
        html += `<button class="tab tab--add" data-tab="__add__">â• ì¶”ê°€</button>`;
        $tabs.innerHTML = html;

        $tabs.querySelectorAll('.tab').forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.dataset.tab === '__add__') { openRegisterModal(); return; }
            currentTab = btn.dataset.tab;
            renderTabs();
            renderViews();
            render();
          });
        });
      }

      function renderViews() {
        // Keep calendar view, remove old dynamic views, add new ones
        const existing = $content.querySelectorAll('.view:not(#view-calendar)');
        existing.forEach(v => v.remove());
        data.instruments.forEach(inst => {
          const sec = document.createElement('section');
          sec.className = 'view' + (currentTab === inst.id ? ' active' : '');
          sec.id = `view-${inst.id}`;
          sec.innerHTML = `<div id="${inst.id}-list"></div>`;
          $content.appendChild(sec);
        });
        // Update calendar visibility
        $('view-calendar').className = 'view' + (currentTab === 'calendar' ? ' active' : '');
      }

      // â•â•â• INSTRUMENT SELECT (lesson modal) â•â•â•
      function populateInstrumentSelect() {
        $fInst.innerHTML = data.instruments.map(i =>
          `<option value="${i.id}">${i.emoji} ${i.name}</option>`
        ).join('');
      }

      // â•â•â• CALENDAR â•â•â•
      function renderCalendar() {
        const firstDay = new Date(calYear, calMonth, 1).getDay();
        const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
        const mNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        const dLabels = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        const byDay = {};
        data.lessons.forEach(l => {
          if (!l.date) return;
          const d = toDateObj(l.date);
          if (d.getFullYear() === calYear && d.getMonth() === calMonth) {
            const day = d.getDate();
            if (!byDay[day]) byDay[day] = [];
            byDay[day].push(l);
          }
        });
        const todayStr = formatDate(todayObj);

        let html = `<div class="calendar__nav">
        <button class="calendar__arrow" id="cal-prev">â—€</button>
        <span class="calendar__month">${calYear}ë…„ ${mNames[calMonth]}</span>
        <button class="calendar__arrow" id="cal-next">â–¶</button>
      </div><div class="calendar__grid">`;

        dLabels.forEach(d => { html += `<div class="calendar__day-label">${d}</div>`; });
        for (let i = 0; i < firstDay; i++) html += `<div class="calendar__day empty"></div>`;

        for (let d = 1; d <= daysInMonth; d++) {
          const ds = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const isToday = ds === todayStr, isSel = ds === selectedDate;
          const lessons = byDay[d] || [];
          const instIds = [...new Set(lessons.map(l => l.instrument))];
          let cls = 'calendar__day' + (isToday ? ' today' : '') + (isSel ? ' selected' : '');
          let dots = '';
          if (instIds.length > 0) {
            dots = '<div class="calendar__dots">';
            instIds.forEach(id => {
              const inst = getInst(id);
              if (inst) dots += `<span class="calendar__dot" style="background:${inst.color}"></span>`;
            });
            dots += '</div>';
          }
          html += `<div class="${cls}" data-date="${ds}">${d}${dots}</div>`;
        }
        html += '</div>';
        $calendar.innerHTML = html;

        $('cal-prev').addEventListener('click', () => {
          calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } selectedDate = null; renderCalendar(); renderDayEvents();
        });
        $('cal-next').addEventListener('click', () => {
          calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } selectedDate = null; renderCalendar(); renderDayEvents();
        });
        $calendar.querySelectorAll('.calendar__day:not(.empty)').forEach(el => {
          el.addEventListener('click', () => { selectedDate = el.dataset.date; renderCalendar(); renderDayEvents(); });
        });
      }

      function renderDayEvents() {
        if (!selectedDate) { $dayEvents.innerHTML = ''; return; }
        const lessons = data.lessons.filter(l => l.date === selectedDate);
        let html = `<div class="day-events__title">ğŸ“Œ ${koreanDate(selectedDate)}</div>`;
        if (!lessons.length) html += `<div class="day-events__empty">ì´ ë‚ ì— ì˜ˆì •ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
        else lessons.forEach(l => { html += renderCard(l); });
        $dayEvents.innerHTML = html;
        attachCardEvents($dayEvents);
      }

      // â•â•â• STATS â•â•â•
      function renderStats() {
        $stats.innerHTML = data.instruments.map(inst => {
          const done = data.lessons.filter(l => l.instrument === inst.id && l.status === 'done').length;
          const total = data.lessons.filter(l => l.instrument === inst.id).length;
          return `<div class="stat-card" style="--sc:${inst.color}">
          <div class="stat-card__label">${inst.emoji} ${inst.name} ì§„í–‰ë¥ </div>
          <div class="stat-card__value" style="color:${inst.color}">${done} / ${total}</div>
        </div>`;
        }).join('');
      }

      // â•â•â• LESSON CARD â•â•â•
      function renderCard(l) {
        const inst = getInst(l.instrument);
        const em = inst ? inst.emoji : 'ğŸµ';
        const c = inst ? inst.color : '#888';
        const c2 = inst ? inst.color2 : '#aaa';
        const st = l.status === 'done'
          ? '<span class="lesson-card__status lesson-card__status--done">âœ… ì™„ë£Œ</span>'
          : '<span class="lesson-card__status lesson-card__status--upcoming">â³ ì˜ˆì •</span>';
        return `<div class="lesson-card" style="--ic:${c};--ic2:${c2}" data-id="${l.id}">
        <div class="lesson-card__header">
          <span class="lesson-card__week">${em} ${l.week}ì£¼ì°¨</span>
          <div class="lesson-card__actions">
            <button class="lesson-card__action" data-action="edit" data-id="${l.id}" title="ìˆ˜ì •">âœï¸</button>
            <button class="lesson-card__action lesson-card__action--delete" data-action="delete" data-id="${l.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="lesson-card__title">${l.title}</div>
        <div class="lesson-card__desc">${l.desc}</div>
        ${l.song ? `<span class="lesson-card__song">â™ª ${l.song}</span>` : ''}
        <div class="lesson-card__date">${l.date ? `ğŸ“… ${koreanDate(l.date)}` : 'ğŸ“… ë‚ ì§œ ë¯¸ì •'} ${st}</div>
      </div>`;
      }

      function attachCardEvents(container) {
        container.querySelectorAll('[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', e => { e.stopPropagation(); openEditModal(Number(btn.dataset.id)); });
        });
        container.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', e => { e.stopPropagation(); confirmAction(Number(btn.dataset.id)); });
        });
        container.querySelectorAll('.lesson-card').forEach(card => {
          card.addEventListener('click', () => {
            const id = Number(card.dataset.id);
            const lesson = data.lessons.find(l => l.id === id);
            if (lesson) {
              lesson.status = lesson.status === 'done' ? 'upcoming' : 'done';
              saveData(data);
              showToast(lesson.status === 'done' ? 'âœ… ì™„ë£Œ ì²˜ë¦¬!' : 'â³ ì˜ˆì •ìœ¼ë¡œ ë³€ê²½');
              render();
            }
          });
        });
      }

      // â•â•â• LIST â•â•â•
      function renderList(instId) {
        const el = $(instId + '-list');
        if (!el) return;
        const lessons = data.lessons.filter(l => l.instrument === instId).sort((a, b) => a.week - b.week);
        const inst = getInst(instId);
        if (!lessons.length) {
          el.innerHTML = `<div class="empty-state"><div class="empty-state__icon">${inst ? inst.emoji : 'ğŸµ'}</div>
          <div class="empty-state__text">ë“±ë¡ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.<br>ï¼‹ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš”!</div></div>`;
          return;
        }
        el.innerHTML = lessons.map(renderCard).join('');
        attachCardEvents(el);
      }

      // â•â•â• LESSON MODAL â•â•â•
      function openAddModal() {
        if (!data.instruments.length) { showToast('ë¨¼ì € ì•…ê¸°ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”', 'error'); return; }
        editingId = null;
        $modalTitle.textContent = 'ìˆ˜ì—… ì¶”ê°€';
        $deleteRow.style.display = 'none';
        populateInstrumentSelect();
        const ci = data.instruments.find(i => i.id === currentTab);
        $fInst.value = ci ? ci.id : data.instruments[0].id;
        $fWeek.value = ''; $fTitle.value = ''; $fDesc.value = '';
        $fSong.value = ''; $fDate.value = ''; $fStatus.value = 'upcoming';
        $modalOvl.classList.add('active');
      }

      function openEditModal(id) {
        const lesson = data.lessons.find(l => l.id === id);
        if (!lesson) return;
        editingId = id;
        $modalTitle.textContent = 'ìˆ˜ì—… ìˆ˜ì •';
        $deleteRow.style.display = 'flex';
        populateInstrumentSelect();
        $fId.value = id; $fInst.value = lesson.instrument;
        $fWeek.value = lesson.week; $fTitle.value = lesson.title;
        $fDesc.value = lesson.desc; $fSong.value = lesson.song || '';
        $fDate.value = lesson.date || ''; $fStatus.value = lesson.status;
        $modalOvl.classList.add('active');
      }

      function closeModal() { $modalOvl.classList.remove('active'); editingId = null; }

      $form.addEventListener('submit', e => {
        e.preventDefault();
        const instrument = $fInst.value, week = parseInt($fWeek.value) || 1;
        const title = $fTitle.value.trim(), desc = $fDesc.value.trim();
        const song = $fSong.value.trim(), date = $fDate.value, status = $fStatus.value;
        if (!title) { showToast('ìˆ˜ì—… ì£¼ì œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”', 'error'); return; }
        if (editingId) {
          const lesson = data.lessons.find(l => l.id === editingId);
          if (lesson) { Object.assign(lesson, { instrument, week, title, desc, song, date, status }); showToast('âœï¸ ìˆ˜ì—…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'); }
        } else {
          data.lessons.push({ id: data.nextId++, instrument, week, title, desc, song, date, status });
          showToast('âœ… ìˆ˜ì—…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        saveData(data); closeModal(); render();
      });

      // â•â•â• REGISTRATION MODAL â•â•â•
      let regStep = 1, regSelectedKey = null, regCustom = false;

      function openRegisterModal() {
        regStep = 1; regSelectedKey = null; regCustom = false;
        renderRegStep1();
        $regOvl.classList.add('active');
      }
      function closeRegModal() { $regOvl.classList.remove('active'); }
      $regOvl.addEventListener('click', e => { if (e.target === $regOvl) closeRegModal(); });

      function renderRegStep1() {
        let html = `<h2 class="modal__title">ì•…ê¸° ë“±ë¡</h2>
        <p class="reg-subtitle">ë“±ë¡í•  ì•…ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš” (ê°™ì€ ì•…ê¸°ë„ ì—¬ëŸ¬ ë²ˆ ë“±ë¡ ê°€ëŠ¥)</p>
        <div class="reg-grid">`;
        Object.keys(TEMPLATES).forEach(key => {
          const t = TEMPLATES[key];
          html += `<button class="reg-card" data-key="${key}">
          <span class="reg-card__emoji">${t.emoji}</span>
          <span class="reg-card__name">${t.name}</span>
          <span class="reg-card__info">ìµœëŒ€ ${t.max}ì£¼</span>
        </button>`;
        });
        html += `<button class="reg-card reg-card--custom" data-key="__custom__">
        <span class="reg-card__emoji">âœï¸</span>
        <span class="reg-card__name">ì§ì ‘ ì…ë ¥</span>
        <span class="reg-card__info">ì»¤ìŠ¤í…€ ì•…ê¸°</span>
      </button></div>
      <div class="modal__btns"><button type="button" class="btn btn--cancel" id="reg-close">ë‹«ê¸°</button></div>`;
        $regContent.innerHTML = html;
        $('reg-close').addEventListener('click', closeRegModal);
        $regContent.querySelectorAll('.reg-card').forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.dataset.key === '__custom__') { regCustom = true; renderRegStepCustom(); }
            else { regSelectedKey = btn.dataset.key; regCustom = false; renderRegStep2(); }
          });
        });
      }

      function renderRegStep2() {
        const t = TEMPLATES[regSelectedKey];
        const todayStr = formatDate(new Date());
        let html = `<h2 class="modal__title">${t.emoji} ${t.name} ë“±ë¡</h2>
        <p class="reg-subtitle">ì»¤ë¦¬í˜ëŸ¼ ì„¤ì •</p>
        <div class="form-group"><label>ì£¼ì°¨ ì„ íƒ</label>
        <div class="week-grid">`;
        for (let w = 4; w <= t.max; w += 4) {
          html += `<button type="button" class="week-btn ${w === 4 ? 'active' : ''}" data-weeks="${w}">
          <span class="week-btn__num">${w}ì£¼</span>
          <span class="week-btn__desc">${t.weeks[w - 1] ? t.weeks[w - 1].title : ''}</span>
        </button>`;
        }
        html += `</div></div>
        <div class="form-row">
          <div class="form-group"><label>ì‹œì‘ì¼</label>
            <input type="date" id="reg-start-date" value="${todayStr}" />
          </div>
          <div class="form-group"><label>ì£¼ë‹¹ íšŸìˆ˜</label>
            <div class="freq-grid">
              <button type="button" class="freq-btn active" data-freq="1">ì£¼ 1íšŒ</button>
              <button type="button" class="freq-btn" data-freq="2">ì£¼ 2íšŒ</button>
              <button type="button" class="freq-btn" data-freq="3">ì£¼ 3íšŒ</button>
            </div>
          </div>
        </div>
        <div class="modal__btns">
          <button type="button" class="btn btn--cancel" id="reg-back">â† ë’¤ë¡œ</button>
          <button type="button" class="btn btn--save" id="reg-next">ë‹¤ìŒ â†’</button>
        </div>`;
        $regContent.innerHTML = html;

        let selWeeks = 4, selFreq = 1;

        $regContent.querySelectorAll('.week-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            $regContent.querySelectorAll('.week-btn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active'); selWeeks = Number(btn.dataset.weeks);
          });
        });
        $regContent.querySelectorAll('.freq-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            $regContent.querySelectorAll('.freq-btn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active'); selFreq = Number(btn.dataset.freq);
          });
        });

        $('reg-back').addEventListener('click', renderRegStep1);
        $('reg-next').addEventListener('click', () => {
          const startDate = $('reg-start-date').value;
          renderRegStep3(regSelectedKey, selWeeks, startDate, selFreq);
        });
      }

      function renderRegStepCustom() {
        const todayStr = formatDate(new Date());
        let html = `<h2 class="modal__title">âœï¸ ì»¤ìŠ¤í…€ ì•…ê¸° ë“±ë¡</h2>
        <div class="form-group"><label>ì•…ê¸° ì´ë¦„</label>
          <input type="text" id="reg-name" placeholder="ì˜ˆ: í•˜ëª¨ë‹ˆì¹´" /></div>
        <div class="form-group"><label>ì´ëª¨ì§€ ì„ íƒ</label>
          <div class="emoji-grid" id="emoji-grid">
            ${CUSTOM_EMOJIS.map((e, i) => `<button type="button" class="emoji-btn ${i === 0 ? 'active' : ''}" data-emoji="${e}">${e}</button>`).join('')}
          </div></div>
        <div class="form-group"><label>ìƒ‰ìƒ ì„ íƒ</label>
          <div class="color-grid" id="color-grid">
            ${COLOR_PALETTE.map((c, i) => `<button type="button" class="color-btn ${i === 0 ? 'active' : ''}" data-color="${c.color}" data-color2="${c.color2}" style="background:${c.color}"></button>`).join('')}
          </div></div>
        <div class="form-group"><label>ì£¼ì°¨ ìˆ˜</label>
          <div class="week-grid week-grid--small">
            ${[4, 8, 12, 16, 20, 24, 28, 32, 36, 40].map((w, i) => `<button type="button" class="week-btn week-btn--sm ${i === 0 ? 'active' : ''}" data-weeks="${w}">${w}ì£¼</button>`).join('')}
          </div></div>
        <div class="form-row">
          <div class="form-group"><label>ì‹œì‘ì¼</label>
            <input type="date" id="reg-cstart-date" value="${todayStr}" />
          </div>
          <div class="form-group"><label>ì£¼ë‹¹ íšŸìˆ˜</label>
            <div class="freq-grid">
              <button type="button" class="freq-btn active" data-freq="1">ì£¼ 1íšŒ</button>
              <button type="button" class="freq-btn" data-freq="2">ì£¼ 2íšŒ</button>
              <button type="button" class="freq-btn" data-freq="3">ì£¼ 3íšŒ</button>
            </div>
          </div>
        </div>
        <div class="modal__btns">
          <button type="button" class="btn btn--cancel" id="reg-back2">â† ë’¤ë¡œ</button>
          <button type="button" class="btn btn--save" id="reg-custom-ok">ë“±ë¡</button>
        </div>`;
        $regContent.innerHTML = html;

        let selEmoji = CUSTOM_EMOJIS[0], selColor = COLOR_PALETTE[0].color, selColor2 = COLOR_PALETTE[0].color2, selWeeks = 4, selFreq = 1;

        $regContent.querySelectorAll('.emoji-btn').forEach(b => {
          b.addEventListener('click', () => {
            $regContent.querySelectorAll('.emoji-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); selEmoji = b.dataset.emoji;
          });
        });
        $regContent.querySelectorAll('.color-btn').forEach(b => {
          b.addEventListener('click', () => {
            $regContent.querySelectorAll('.color-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); selColor = b.dataset.color; selColor2 = b.dataset.color2;
          });
        });
        $regContent.querySelectorAll('.week-btn--sm').forEach(b => {
          b.addEventListener('click', () => {
            $regContent.querySelectorAll('.week-btn--sm').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); selWeeks = Number(b.dataset.weeks);
          });
        });
        $regContent.querySelectorAll('.freq-btn').forEach(b => {
          b.addEventListener('click', () => {
            $regContent.querySelectorAll('.freq-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active'); selFreq = Number(b.dataset.freq);
          });
        });

        $('reg-back2').addEventListener('click', renderRegStep1);
        $('reg-custom-ok').addEventListener('click', () => {
          const name = $('reg-name').value.trim();
          if (!name) { showToast('ì•…ê¸° ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”', 'error'); return; }
          const startDate = $('reg-cstart-date').value;
          const id = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
          const inst = { id, name, emoji: selEmoji, color: selColor, color2: selColor2 };
          data.instruments.push(inst);
          const r = generateEmptyLessons(id, selWeeks, data.nextId, startDate, selFreq);
          data.lessons = data.lessons.concat(r.lessons);
          data.nextId = r.nextId;
          saveData(data);
          currentTab = id;
          closeRegModal();
          showToast(`${selEmoji} ${name} ë“±ë¡ ì™„ë£Œ!`);
          renderTabs(); renderViews(); render();
        });
      }

      function renderRegStep3(templateKey, weekCount, startDate, freq) {
        const t = TEMPLATES[templateKey];
        const preview = t.weeks.slice(0, weekCount);
        const dates = calcDates(startDate, preview.length, freq || 1);
        const freqLabel = freq === 3 ? 'ì£¼ 3íšŒ' : freq === 2 ? 'ì£¼ 2íšŒ' : 'ì£¼ 1íšŒ';
        let html = `<h2 class="modal__title">${t.emoji} ${t.name} Â· ${weekCount}ì£¼</h2>
        <p class="reg-subtitle">ğŸ“… ì‹œì‘: ${koreanDate(startDate)} Â· ${freqLabel}</p>
        <div class="preview-list">`;
        preview.forEach((w, i) => {
          html += `<div class="preview-item">
          <span class="preview-item__week">${w.week}ì£¼ì°¨</span>
          <div><div class="preview-item__title">${w.title}</div>
          <div class="preview-item__desc">${w.desc}</div>
          <div class="preview-item__date">ğŸ“… ${koreanDate(formatDate(dates[i]))}</div></div>
        </div>`;
        });
        html += `</div>
        <div class="modal__btns">
          <button type="button" class="btn btn--cancel" id="reg-back3">â† ë’¤ë¡œ</button>
          <button type="button" class="btn btn--save" id="reg-confirm">ë“±ë¡í•˜ê¸°</button>
        </div>`;
        $regContent.innerHTML = html;
        $('reg-back3').addEventListener('click', () => renderRegStep2());
        $('reg-confirm').addEventListener('click', () => {
          const uniqueId = templateKey + '_' + Date.now();
          const inst = { id: uniqueId, name: t.name, emoji: t.emoji, color: t.color, color2: t.color2 };
          data.instruments.push(inst);
          const r = generateLessons(templateKey, uniqueId, weekCount, data.nextId, startDate, freq);
          data.lessons = data.lessons.concat(r.lessons);
          data.nextId = r.nextId;
          saveData(data);
          currentTab = uniqueId;
          closeRegModal();
          showToast(`${t.emoji} ${t.name} ${weekCount}ì£¼ ì»¤ë¦¬í˜ëŸ¼ ë“±ë¡ ì™„ë£Œ!`);
          renderTabs(); renderViews(); render();
        });
      }

      // â•â•â• DELETE / CONFIRM â•â•â•
      let pendingDeleteId = null;
      function confirmAction(id) {
        pendingDeleteId = id;
        $('confirm-title').textContent = 'í™•ì¸';
        $('confirm-msg').textContent = 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        $('confirm-yes').textContent = 'ì‚­ì œ';
        $confirmOvl.classList.add('active');
      }

      $('confirm-yes').addEventListener('click', () => {
        if (pendingDeleteId === '__reset__') {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(OLD_KEY);
          data = initDefaultData();
          currentTab = 'calendar';
          showToast('ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ!');
          renderTabs(); renderViews(); render();
        } else if (pendingDeleteId != null) {
          data.lessons = data.lessons.filter(l => l.id !== pendingDeleteId);
          saveData(data); showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
          closeModal(); render();
        }
        pendingDeleteId = null;
        $confirmOvl.classList.remove('active');
      });
      $('confirm-no').addEventListener('click', () => { pendingDeleteId = null; $confirmOvl.classList.remove('active'); });
      $('btn-delete').addEventListener('click', () => { if (editingId) confirmAction(editingId); });

      // â•â•â• TOAST â•â•â•
      let toastTimer;
      function showToast(msg, type = 'success') {
        $toast.textContent = msg;
        $toast.className = `toast toast--${type} visible`;
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => $toast.classList.remove('visible'), 2200);
      }

      // â•â•â• RESET â•â•â•
      $('btn-reset').addEventListener('click', () => {
        pendingDeleteId = '__reset__';
        $('confirm-title').textContent = 'ì´ˆê¸°í™”';
        $('confirm-msg').textContent = 'ëª¨ë“  ë°ì´í„°ë¥¼ ê¸°ë³¸(ì˜¤ì¹´ë¦¬ë‚˜+ìš°ì¿¨ë ë ˆ 20ì£¼)ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?';
        $('confirm-yes').textContent = 'ì´ˆê¸°í™”';
        $confirmOvl.classList.add('active');
      });

      // â•â•â• EVENTS â•â•â•
      $fab.addEventListener('click', openAddModal);
      $('btn-cancel').addEventListener('click', closeModal);
      $modalOvl.addEventListener('click', e => { if (e.target === $modalOvl) closeModal(); });

      // â•â•â• MASTER RENDER â•â•â•
      function render() {
        renderStats();
        renderCalendar();
        renderDayEvents();
        data.instruments.forEach(inst => renderList(inst.id));
      }

      // â•â•â• INIT â•â•â•
      renderTabs();
      renderViews();
      render();
    })();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW registration failed:', err));
    }
  </script>
</body>

</html>